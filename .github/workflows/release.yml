name: å‘å¸ƒæž„å»º

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build-standalone:
    name: æž„å»ºç‹¬ç«‹åº”ç”¨
    runs-on: windows-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: æž„å»ºç‹¬ç«‹åº”ç”¨
        run: npm run build:standalone
      
      - name: æµ‹è¯•ç‹¬ç«‹åº”ç”¨
        run: npm run test:standalone
      
      - name: æ‰“åŒ…ç‹¬ç«‹åº”ç”¨
        run: npm run package:standalone
      
      - name: ä¸Šä¼ ç‹¬ç«‹åº”ç”¨æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: standalone-windows
          path: |
            release-standalone/*.exe
            release-standalone/*.zip
          retention-days: 30
  
  build-extension:
    name: æž„å»ºVSCodiumæ‰©å±•
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: æž„å»ºVSCodiumæ‰©å±•
        run: npm run build:extension
      
      - name: æµ‹è¯•VSCodiumæ‰©å±•
        run: npm run test:extension
      
      - name: æ‰“åŒ…VSCodiumæ‰©å±•
        run: npm run package:extension
      
      - name: ä¸Šä¼ VSCodiumæ‰©å±•æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: vscodium-extension
          path: |
            release-extension/*.vsix
            release-extension/INSTALL.md
          retention-days: 30
  
  create-release:
    name: åˆ›å»ºGitHub Release
    needs: [build-standalone, build-extension]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
      
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          cat > release-notes.md << 'EOF'
          # ZSide4CD ${VERSION} å‘å¸ƒ
          
          åŸºäºŽVSCodiumçš„ä¸­æ–‡åŒ–åµŒå…¥å¼å¼€å‘IDEï¼Œä¸“ä¸ºSTM32F429å’ŒTI C67XXç³»åˆ—å¤„ç†å™¨è®¾è®¡ã€‚
          
          ## ðŸŽ¯ ä¸»è¦ç‰¹æ€§
          
          - âœ… å®Œæ•´ä¸­æ–‡åŒ–ç•Œé¢å’Œæ–‡æ¡£
          - âœ… STM32F429å¤„ç†å™¨æ”¯æŒï¼ˆARM GCCå·¥å…·é“¾ï¼‰
          - âœ… TI C67XXå¤„ç†å™¨æ”¯æŒï¼ˆTI CGTå·¥å…·é“¾ï¼‰
          - âœ… æ™ºèƒ½å·¥å…·é“¾ç®¡ç†ï¼ˆè‡ªåŠ¨æ£€æµ‹å’Œé…ç½®ï¼‰
          - âœ… å®Œæ•´çš„ç¼–è¯‘ã€è°ƒè¯•å’Œçƒ§å½•åŠŸèƒ½
          - âœ… Windows 10/11å®Œæ•´æ”¯æŒ
          
          ## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          
          ### ç‹¬ç«‹åº”ç”¨ç‰ˆï¼ˆæŽ¨èæ–°ç”¨æˆ·ï¼‰
          
          - **ZSide4CD-${VERSION}-Setup.exe** - Windowså®‰è£…ç‰ˆï¼ˆçº¦80MBï¼‰
            - å®Œæ•´çš„æ¡Œé¢IDEåº”ç”¨
            - å¼€ç®±å³ç”¨ï¼Œæ— éœ€å®‰è£…VSCodium
            - é€‚åˆé¦–æ¬¡ä½¿ç”¨çš„ç”¨æˆ·
          
          - **ZSide4CD-${VERSION}-Portable.exe** - Windowsä¾¿æºç‰ˆ
            - æ— éœ€å®‰è£…ï¼Œè§£åŽ‹å³ç”¨
            - é€‚åˆéœ€è¦ç§»åŠ¨ä½¿ç”¨çš„åœºæ™¯
          
          ### VSCodiumæ‰©å±•ç‰ˆï¼ˆæŽ¨èVSCodiumç”¨æˆ·ï¼‰
          
          - **zside4cd-${VERSION}.vsix** - VSCodiumæ‰©å±•åŒ…ï¼ˆçº¦5MBï¼‰
            - è½»é‡çº§ï¼Œå……åˆ†åˆ©ç”¨VSCodiumç”Ÿæ€
            - éœ€è¦å…ˆå®‰è£…VSCodiumï¼ˆhttps://vscodium.com/ï¼‰
            - å®‰è£…æ–¹æ³•è¯·å‚é˜…INSTALL.md
          
          ## ðŸš€ å¿«é€Ÿå¼€å§‹
          
          ### ç‹¬ç«‹åº”ç”¨
          1. ä¸‹è½½ ZSide4CD-${VERSION}-Setup.exe
          2. åŒå‡»å®‰è£…
          3. å¯åŠ¨ZSide4CD
          4. åˆ›å»ºæ–°çš„STM32æˆ–C67XXé¡¹ç›®
          5. å¼€å§‹å¼€å‘ï¼
          
          ### VSCodiumæ‰©å±•
          1. å®‰è£…VSCodiumï¼ˆå¦‚æžœå°šæœªå®‰è£…ï¼‰
          2. ä¸‹è½½ zside4cd-${VERSION}.vsix
          3. åœ¨VSCodiumä¸­æ‰§è¡Œï¼š\`codium --install-extension zside4cd-${VERSION}.vsix\`
          4. é‡å¯VSCodium
          5. åœ¨ä¾§è¾¹æ æ‰¾åˆ°ZSide4CDå›¾æ ‡
          
          ## ðŸ“š æ–‡æ¡£
          
          - [ç”¨æˆ·æ‰‹å†Œ](https://github.com/forfire912/zside4cd/blob/main/docs/user-guide.md)
          - [å¿«é€Ÿå¼€å§‹æŒ‡å—](https://github.com/forfire912/zside4cd/blob/main/docs/quick-start.md)
          - [ç¼–è¯‘æŒ‡å—](https://github.com/forfire912/zside4cd/blob/main/docs/build-guide.md)
          - [VSCodiumé›†æˆè¯´æ˜Ž](https://github.com/forfire912/zside4cd/blob/main/docs/vscodium-integration.md)
          
          ## ðŸ› é—®é¢˜åé¦ˆ
          
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨GitHub Issuesä¸­åé¦ˆï¼š
          https://github.com/forfire912/zside4cd/issues
          
          ## ðŸ“ æ›´æ–°æ—¥å¿—
          
          è¯¦ç»†æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹ï¼š[CHANGELOG.md](https://github.com/forfire912/zside4cd/blob/main/CHANGELOG.md)
          
          ---
          
          **è®¸å¯è¯**: MIT License
          **åŸºäºŽ**: VSCodium (MIT License)
          EOF
          echo "::set-output name=notes::$(cat release-notes.md)"
      
      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          name: ZSide4CD ${{ github.ref_name }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            standalone-windows/*.exe
            standalone-windows/*.zip
            vscodium-extension/*.vsix
            vscodium-extension/INSTALL.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
